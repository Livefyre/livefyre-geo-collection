<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geo Filtering</title>
    <link rel="stylesheet" type="text/css" href="http://s.codepen.io/assets/reset/normalize.css" />
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <style>
    body {
        color: #333;
    }
    h2 {
        margin: 4px 0;
    }

    .quick {
        margin: 10px 0 0 0;
    }

    ul {
        list-style-type: none;
        font-size: 18px;
    }

    #id {
        margin: 0 auto;
        width: 1024px;
    }

    #map {
        height: 500px;
    }

    .visible {
        visibility: visible !important;
    }

    .leaflet-container {
        background: url('http://client-solutions.livefyre.com/cid/maps/ajax-loader.gif') center center no-repeat #fff;
    }

    .leaflet-popup-content {
        text-align: left;
    }

    </style>
    <script src="http://client-solutions.livefyre.com/cid/maps/modernizr-geo.js"></script>
    <script>
    // Polly Fill if browser doesn't support geo
    Modernizr.load({
        test: Modernizr.geolocation,
        yep: '',
        nope: 'http://client-solutions.livefyre.com/cid/maps/geo-polyfill.js'
    });
    </script>
</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <ul class="sidebar-tabs" role="tablist">
            <li><a href="#home" role="tab"><i class="fa fa-bars"></i></a></li>
            <li><a href="#settings" role="tab"><i class="fa fa-gear"></i></a></li>
            <li><a href="#profile" role="tab"><i class="fa fa-map-marker"></i></a></li>
            <li><a href="#messages" role="tab"><i class="fa fa-fast-forward"></i></a></li>
        </ul>

        <!-- Tab panes -->
        <div class="sidebar-content active">
            <div class="sidebar-pane" id="home">
                <h2>Geo Fence</h2>
                <p>Use the icons to the left or adjust the Marker <i class="fa fa-map-marker"></i> position to get started. If no distance is set in the Settings section <i class="fa fa-gear"></i> a radial distance of 0.1 will be applied.</p>
            </div>
            <div class="sidebar-pane" id="settings">
                <h2>Fence Radius</h2>
                <form class="form-inline" role="form" id="radius-form">
                    <div class="form-group">
                        <label for="distance"></label>
                        <input class="" value="" id="distance" placeholder="Radial Min: 0.1" />
                        <select id="units">
                            <option value="mi">mi</option>
                            <option value="km">km</option>
                        </select>
                        <button type="submit" class="btn" id="submit-radius">
                            Create
                        </button>
                    </div>
                </form>
                <p class="error"></p>
            </div>
            <div class="sidebar-pane" id="profile">
                <h2>Marker Coordinates</h2>
                <ul>
                    <li id="js-your-lat">Latitude: <span></span></li>
                    <li id="js-your-lon">Longitude: <span></span></li>
                    <li id="js-your-zoom">Zoom: <span></span></li>
                </ul>
            </div>
            <div class="sidebar-pane" id="messages">
                <h2>Quick Links</h2>
                <button data-lat="37.7749300" data-lng="-122.4194200" class="btn quick" id="sf">
                    San Francisco
                </button>
    <!--
                <button class="btn quick" data-city="Watch out for tornados!" data-lat="38.959902" data-lng="-95.253199" id="kansas">
                    Lawrence, KS
                </button>
-->
                <button data-lat="" data-lng="" class="btn quick" id="you">
                    Your Location
                </button>
                <button class="btn quick" data-lat="40.7142700" data-lng="-74.0059700" id="nyc">
                    New York City
                </button>
            </div>
        </div>
    </div>

    <div id="map" class="sidebar-map"></div>
    <main id="app"></main>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="js/leaflet-sidebar.min.js"></script>
    <script src="https://cdn.livefyre.com/Livefyre.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>
    "use strict";

    var geoCoords = {};
    var geometry = null;
    var fenceState = false;
    var fence = null;
    var wallState = false;
    var markerMoved = false;
    var marker = null;
    var map = null;
    var distance = null;
    var unitType = null;
    var wall = null;

    // bruces collection http://admin.client-demo-accounts.fyre.co/v3/site/372680/collections/122538518
    var weatherCollection = {
        network: 'client-demo-accounts.fyre.co',
        siteId: 372680,
        articleId: 'custom-1426705037726'
    };

    var cidsWeatherCollection = {
        network: 'sales.fyre.co',
        siteId: 371516,
        articleId: 'custom-1431365679102'
    };

    var bensCollection = {
        network: 'labs-t402.fyre.co',
        siteId: 303827,
        articleId: 'uat-ben-geo-0'
    };

    function geoUpdateUI(data) {
        $('#js-your-lat > span').text(data.x);
        $('#js-your-lon > span').text(data.y);
        $('#js-your-zoom > span').text(data.z);
    }

    function mapSetView(geoCoords, addFence, renderMediawall) {
        var latlng = L.latLng(geoCoords.x, geoCoords.y);
        map.setView(latlng);
        marker.setLatLng(latlng);
        marker.setPopupContent('Latitude: ' + geoCoords.x + ' <br /> Longitude: ' + geoCoords.y);
        markerMoved = true;
        if (fenceState) {
            removeFence(fence);
        }
        geoUpdateUI(geoCoords);
        createPoly(geoCoords, addFence, renderMediawall);
    }

    function mapInit(geoCoords) {

        var map = window.map = L.map('map', {
            zoomControl: false
        });

        map.locate({
            setView: true,
            maxZoom: 15,
            enableHighAccuracy: true,
            maximumAge: 59999.9
        });


        var zoomControl = L.control.zoom({
            position: 'topright'
        });

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: 'Livefyre Geo Maps',
            reuseTiles: true,
            detectRetina: true
        }).addTo(map);

        map.addControl(zoomControl);

        map.on('load', function(e) {
            var center = map.getCenter();

            geoCoords.x = center.lat;
            geoCoords.y = center.lng;
            geoCoords.z = map.getZoom();

            $('#you').data({
                'lat': geoCoords.x,
                'lng': geoCoords.y
            });

            addMarker(center);
            updateView(geoCoords);

            var sidebar = L.control.sidebar('sidebar').addTo(map);


        });

        map.on('zoomend', function(e) {
            var currentZ = map.getZoom();
            geoCoords.z = currentZ;
            $('#js-your-zoom > span').text(currentZ);
        });

        map.on('click', function(e) {

        });


    }

    function addFence(geometry) {
      fenceState = true;
      fence = L.geoJson(geometry, {
          style: function(feature) {
              return {
                  color: 'red'
              };
          },
          onEachFeature: function(feature, layer) {
              layer.bindPopup('The diameter of your fence is <br /> ' + (distance * 2) +' ' + unitType + '.');
          }
      });
      map.addLayer(fence);
      map.fitBounds(fence.getBounds());
    }

    function removeFence(fence) {
      try {
          map.removeLayer(fence);
      } catch (e) {}
    }

    function updateView(geoCoords) {
      $('#js-your-lat > span').text(geoCoords.x);
      $('#js-your-lon > span').text(geoCoords.y);
      $('#js-your-zoom > span').text(geoCoords.z);
    }

    function addMarker(o) {
        marker = L.marker([o.lat, o.lng], {
            draggable: true
        });

        marker.addTo(map);
        marker.bindPopup('Found you!');
        marker.openPopup();

        marker.on('dragend', function(e) {
            geoCoords.x = e.target._latlng.lat;
            geoCoords.y = e.target._latlng.lng;
            marker.setPopupContent('Latitude: ' + geoCoords.x + ' <br /> Longitude: ' + geoCoords.y);
            geoUpdateUI(geoCoords);
            removeFence(fence);
            markerMoved = true;
            createPoly(geoCoords, addFence, renderMediawall);
        });
        marker.on('dragstart', function(e) {

        });
    }

    function renderMediawall(geometry) {
      if (wallState) {
        try {
            wall.destroy();
            $('#map').after('<main id="app"></main>');
        } catch (e) { }
      }
      Livefyre.require([
              'streamhub-wall#3',
              'streamhub-sdk#2',
              'livefyre-geo-collection#0'

          ],
          function(Wall, SDK, GeoCollection) {

              var appEl = document.getElementById('app');
              var geoCollection = new(GeoCollection.GeoCollection)({
                  collection: bensCollection,
                  geometry: geometry,
                  transformState: function stateToContent(state) {
                      var contents = SDK.StateToContent.transform(state);
                      if (!(contents && contents.length)) {
                          return;
                      }
                      var content = contents[0];
                      return content;
                  }
              });

              wall = window.wall = new Wall({
                  el: appEl,
                  collection: geoCollection
              });
          });
      wallState = true;
    }

    function createPoly(geoCoords, addFence, renderMediawall) {

        var radiusInMeters, validInput, angleDegrees;

        distance = parseFloat($('#distance').val(), 10);
        distance = (distance > 0) ? distance : parseFloat('.1', 10);
        unitType = $('#units').val();

        radiusInMeters = convertDistanceToMeters(distance, unitType);
        validInput = validateDistance(radiusInMeters);

        if (!validInput) {
            $('.error').text('Those numbers are out of range. Try again.');
        } else {
            angleDegrees = angularRadiusFromSurfaceRadius(radiusInMeters);
            geometry = createPolydata(angleDegrees, geoCoords);
            addFence(geometry);
            geoCoords.z = map.getZoom();
            renderMediawall(geometry);
            validateGeoJSON(geometry);
            $('#distance').val(distance);
            $('#submit-radius').text('Update');
        }

        function validateDistance(r) {
            var MAX = 3220290; // ~2000 miles
            var MIN = parseFloat('.1');
            return (r < MAX && r > MIN) ? true : false;
        }


        function convertDistanceToMeters(distance, unitType) {
            var distMeters;
            if (unitType === 'km') {
                distMeters = distance * 1000;
            } else if (unitType === 'mi') {
                distMeters = distance * 1609.34;
            }
            return distMeters;
        }

        function angularRadiusFromSurfaceRadius(surfaceRadius) {
            var DISTANCE_TO_CENTER_OF_EARTH_METERS = 6371000;
            var angle = ((surfaceRadius / DISTANCE_TO_CENTER_OF_EARTH_METERS * 180)) / Math.PI;
            return angle;
        }

        function createPolydata(angle, geoCoords) {
            return d3.geo.circle()
              .origin([geoCoords.y, geoCoords.x])
              .angle(angle).precision(1)();
        }

        function validateGeoJSON(geometry) {
            var processSuccess, processError, geoJSON;
            geoJSON = {
                type: "FeatureCollection",
                features: [{
                    type: "Feature",
                    properties: {
                        description: 'Your App will only see content from this shape',
                        color: '#dddddd'
                    },
                    geometry: geometry
                }]
            };

            geoJSON = JSON.stringify(geoJSON);

            processSuccess = function(data) {
                if (data.status === 'ok') {} else if (data.status === 'error') {
                    console.log('There was a problem with your GeoJSON: ' + data.message);
                }
            };

            processError = function() {
                console.log('There was a problem with your ajax.');
            };

            $.ajax({
                url: 'http://geojsonlint.com/validate',
                type: 'POST',
                data: geoJSON,
                dataType: 'json',
                success: processSuccess,
                error: processError
            });
        }
    }

    $('body').on('click', '.quick', function(e) {
        var $el = $(e.target);
        geoCoords.x = parseFloat($el.data('lat'));
        geoCoords.y = parseFloat($el.data('lng'));
        mapSetView(geoCoords, addFence, renderMediawall);
    });
    $('#radius-form').submit(function(e) {
        e.preventDefault();
        $('.error').text('');
        if (fenceState) {
            removeFence(fence);
        }
        createPoly(geoCoords, addFence, renderMediawall);
    });

    mapInit(geoCoords);
    </script>
</body>

</html>