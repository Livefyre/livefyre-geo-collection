<!doctype html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="http://s.codepen.io/assets/reset/normalize.css" />
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <style>
    body {
        color: #333;
    }

    #geo {
        text-align: center;
        margin: 0 auto;
    }

    .quick {
        margin: 10px 0 0 0;
    }

    ul {
        list-style-type: none;
        font-size: 18px;
    }

    #id {
        margin: 0 auto;
        width: 1024px;
    }

    #map {
        height: 500px;
    }

    #loader {
        background: url('http://client-solutions.livefyre.com/cid/maps/ajax-loader.gif') center center no-repeat transparent;
        width: 16px;
        height: 16px;
        display: block;
        visibility: hidden;
        margin: 10px auto;
    }

    .visible {
        visibility: visible !important;
    }

    #js-polygon-wrapper,
    #js-location-wrapper,
    #js-distance-wrapper {
        display: none;
    }

    .leaflet-container {
        background: url('http://www.broadwaybalancesamerica.com/images/ajax-loader.gif') center center no-repeat #fff;
    }

    .leaflet-popup-content {
        text-align: center;
    }
    </style>
    <script src="http://client-solutions.livefyre.com/cid/maps/modernizr-geo.js"></script>
    <script>
    // Polly Fill if browser doesn't support geo
    Modernizr.load({
        test: Modernizr.geolocation,
        yep: '',
        nope: 'http://client-solutions.livefyre.com/cid/maps/geo-polyfill.js'
    });
    </script>
</head>

<body>
    <div id="geo">
        <h1>Geo Filtering a Livefyre Collection</h1>
        <div id="map"></div>
        <div id="js-location-wrapper">
            <h2>Your Geo Point Coordinates</h2>
            <ul>
                <li id="js-your-lat">Latitude: <span></span></li>
                <li id="js-your-lon">Longitude: <span></span></li>
                <li id="js-your-zoom">Zoom: <span></span></li>
                <button data-lat="37.7749300" data-city="Watch out for earthquakes!" data-lng="-122.4194200" class="btn quick" id="sf">
                    San Francisco, CA
                </button>
                <button class="btn quick" data-city="Watch out for tornados!" data-lat="38.959902" data-lng="-95.253199" id="kansas">
                    Lawrence, KS
                </button>
            </ul>
        </div>
        <div id="js-distance-wrapper">
            <h2>Enter Radius From Marker</h2>
            <form class="form-inline" role="form" id="radius-form">
                <div class="form-group">
                    <label for="distance"></label>
                    <input class="" value="" id="distance" placeholder="Radial Min: 0.1" />
                    <select id="units">
                        <option value="mi">mi</option>
                        <option value="km">km</option>
                    </select>
                    <button type="submit" class="btn" id="submit-radius">
                        Create Geo Fenced Media Wall
                    </button>
                </div>
            </form>
            <p class="error"></p>
        </div>
    </div>
    <main id="app"></main>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="https://cdn.livefyre.com/Livefyre.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>
    "use strict";

    var geoCoords = {};
    var geometry = null;
    var fenceState = false;
    var fence = null;
    var wallState = false;
    var markerMoved = false;
    var marker = null;
    var map = null;
    var distance = null;
    var unitType = null;

    // bruces collection http://admin.client-demo-accounts.fyre.co/v3/site/372680/collections/122538518
    var weatherCollection = {
        network: 'client-demo-accounts.fyre.co',
        siteId: 372680,
        articleId: 'custom-1426705037726'
    };

    var bensCollection = {
        network: 'labs-t402.fyre.co',
        siteId: 303827,
        articleId: 'uat-ben-geo-0'
    };

    function geoUpdateUI(data) {
        $('#js-your-lat > span').text(data.x);
        $('#js-your-lon > span').text(data.y);
        $('#js-your-zoom > span').text(data.z);
        $('#js-location-wrapper').show();
        $('#js-distance-wrapper').show();
        $('h2', '#js-location-wrapper').text('New Geo Point Coordinates');
    }

    function mapSetView(geoCoords, text, addFence, renderMediawall) {
        var latlng = L.latLng(geoCoords.x, geoCoords.y);
        map.setView(latlng);
        marker.setLatLng(latlng);
        marker.setPopupContent(text);
        markerMoved = true;
        if (fenceState) {
            removeFence(fence);
        }
        geoUpdateUI(geoCoords);
        createPoly(geoCoords, addFence, renderMediawall);
    }

    function mapInit(geoCoords) {

        map = window.map = L.map('map').locate({
            setView: true,
            maxZoom: 15,
            enableHighAccuracy: true,
            maximumAge: 59999.9,
            worldCopyJump: true
        });

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: 'Livefyre Geo Maps',
            detectRetina: true
        }).addTo(map);

        map.on('load', function(e) {
            var center = map.getCenter();

            geoCoords.x = center.lat;
            geoCoords.y = center.lng;
            geoCoords.z = map.getZoom();

            addMarker(center);
            updateView(geoCoords);

        });

        map.on('zoomend', function(e) {
            var currentZ = map.getZoom();
            geoCoords.z = currentZ;
            $('#js-your-zoom > span').text(currentZ);
        });

        map.on('click', function(e) {

        });
    }

    function addFence(geometry) {
      fenceState = true;
      fence = L.geoJson(geometry, {
          style: function(feature) {
              return {
                  color: 'red'
              };
          },
          onEachFeature: function(feature, layer) {
              layer.bindPopup('This is where your content comes from');
          }
      });
      map.addLayer(fence);
      map.fitBounds(fence.getBounds());
    }

    function removeFence(fence) {
      try {
          map.removeLayer(fence);
      } catch (e) {}
    }

    function updateView(geoCoords) {
      $('#js-your-lat > span').text(geoCoords.x);
      $('#js-your-lon > span').text(geoCoords.y);
      $('#js-your-zoom > span').text(geoCoords.z);
      $('#js-location-wrapper').show();
      $('#js-distance-wrapper').show();
    }

    function addMarker(o) {
        marker = L.marker([o.lat, o.lng], {
            draggable: true
        });

        marker.addTo(map);
        marker.bindPopup('Found you!');
        marker.openPopup();

        marker.on('dragend', function(e) {
            marker.setPopupContent('New Location');
            geoCoords.x = e.target._latlng.lat;
            geoCoords.y = e.target._latlng.lng;
            geoUpdateUI(geoCoords);
            removeFence(fence, map);
            markerMoved = true;
            if (wallState) {
              createPoly(geoCoords, addFence, renderMediawall);
            }
        });
        marker.on('dragstart', function(e) {

        });
    }

    /*
      // not using this function for the demo. using leaflet's geolocator.
      // however this is how a browser would handle finding it's geolocation
        function getGeo (geoCoords, zoomLevel, map, cb) {

            var deferGeo, geoSuccess, geoError, resolvePromise, rejectPromise, getPos, toggleLoader;

            toggleLoader = function() {
              $('#loader').toggleClass('visible');
            };

            deferGeo = new $.Deferred;

            resolvePromise = function() {
                deferGeo.resolve();
            };

            rejectPromise = function() {
                deferGeo.reject();
            };

            geoError = function() {
                rejectPromise();
            };

            geoSuccess = function (x, y, geoCoords, zoomLevel) {
                if (!zoomLevel) {
                  zoomLevel = 1;
                }
                geoCoords.x = x;
                geoCoords.y = y;
                geoCoords.z = zoomLevel;
                resolvePromise();
            };

            getPos = function (deferGeo, zoomLevel) {
              navigator.geolocation.getCurrentPosition(
                  function(pos) {
                      geoSuccess(pos.coords.latitude, pos.coords.longitude, geoCoords, zoomLevel);
                  },
                  function() {
                      geoError();
                  }, {
                      maximumAge: 60000,
                      timeout: 10000,
                      enableHighAccuracy: true
                  }
              );
                return deferGeo.promise();
            };

            deferGeo.done(function() {
              return cb(map, geoCoords);
              })
              .fail(function() {
                conosle.log('could not find you');
              })
              .always(function() {

              });

            getPos(deferGeo, zoomLevel);

        }
      */

    function renderMediawall(geometry) {
      if (wallState) {
        wall.destroy();
        $('#geo').after('<main id="app"></main>');
      }
      Livefyre.require([
              'streamhub-wall#3',
              'streamhub-sdk#2',
              '../dist/livefyre-geo-collection.lf.js'

          ],
          function(Wall, SDK, GeoCollection) {

              var appEl = document.getElementById('app');
              var geoCollection = new(GeoCollection.GeoCollection)({
                  collection: bensCollection,
                  geometry: geometry,
                  transformState: function stateToContent(state) {
                      var contents = SDK.StateToContent.transform(state);
                      if (!(contents && contents.length)) {
                          return;
                      }
                      var content = contents[0];
                      return content;
                  }
              });

              var wall = window.wall = new Wall({
                  el: appEl,
                  collection: geoCollection
              });
          });
      wallState = true;
    }

    function createPoly(geoCoords, addFence, renderMediawall) {

        var radiusInMeters, validInput, angleDegrees;

        distance = parseFloat($('#distance').val(), 10);
        distance = (distance > 0) ? distance : parseFloat('10', 10);
        unitType = $('#units').val();

        radiusInMeters = convertDistanceToMeters(distance, unitType);
        validInput = validateDistance(radiusInMeters);

        if (!validInput) {
            $('.error').text('That\'s pretty big! Try something smaller.');
        } else {
            angleDegrees = angularRadiusFromSurfaceRadius(radiusInMeters);
            geometry = createPolydata(angleDegrees, geoCoords);
            addFence(geometry);
            renderMediawall(geometry);
            validateGeoJSON(geometry);
            $('#distance').val(distance);
        }

        function validateDistance(r) {
            var MAX = 3220290;
            var MIN = parseFloat('.1');
            return (r < MAX && r > MIN) ? true : false;
        }

        function convertDistanceToMeters(distance, unitType) {
            var distMeters;
            if (unitType === 'km') {
                distMeters = distance * 1000;
            } else if (unitType === 'mi') {
                distMeters = distance * 1609.34;
            }
            return distMeters;
        }

        function angularRadiusFromSurfaceRadius(surfaceRadius) {
            var DISTANCE_TO_CENTER_OF_EARTH_METERS = 6371000;
            var angle = ((surfaceRadius / DISTANCE_TO_CENTER_OF_EARTH_METERS * 180)) / Math.PI;
            return angle;
        }

        function createPolydata(angle, geoCoords) {
            return d3.geo.circle()
              .origin([geoCoords.y, geoCoords.x])
              .angle(angle).precision(1)();
        }

        function validateGeoJSON(geometry) {
            var processSuccess, processError, geoJSON;
            geoJSON = {
                type: "FeatureCollection",
                features: [{
                    type: "Feature",
                    properties: {
                        description: 'Your App will only see content from this shape',
                        color: '#dddddd'
                    },
                    geometry: geometry
                }]
            };

            geoJSON = JSON.stringify(geoJSON);

            processSuccess = function(data) {
                if (data.status === 'ok') {} else if (data.status === 'error') {
                    console.log('There was a problem with your GeoJSON: ' + data.message);
                }
            };

            processError = function() {
                console.log('There was a problem with your ajax.');
            };

            $.ajax({
                url: 'http://geojsonlint.com/validate',
                type: 'POST',
                data: geoJSON,
                dataType: 'json',
                success: processSuccess,
                error: processError
            });
        }
    }

    /*
      $('#zoom-form').submit(function(e) {
        e.preventDefault();
        var zoomLevel = $('#zoom').val();
        getGeo(geoCoords, map, zoomLevel);
      });
     */

    $('#distance').focus(function() {
        $(this).val('');
    });

    $('body').on('click', '.quick', function(e) {
        var $el = $(e.target);
        var text = $el.data('city');
        geoCoords.x = $el.data('lat');
        geoCoords.y = $el.data('lng');
        mapSetView(geoCoords, text, addFence, renderMediawall);
    });
    $('#radius-form').submit(function(e) {
        e.preventDefault();
        $('.error').text('');
        $('#submit-radius').text('Update Geo Fenced Media Wall');
        if (fenceState) {
            removeFence(fence);
        }
        createPoly(geoCoords, addFence, renderMediawall);
    });

    mapInit(geoCoords);
    </script>
</body>

</html>
