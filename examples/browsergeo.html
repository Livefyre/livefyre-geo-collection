<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Geo Filtering</title>
    <link rel="stylesheet" type="text/css" href="http://s.codepen.io/assets/reset/normalize.css" />
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
    <link rel="stylesheet" href="css/leaflet-sidebar.css" />
    <link rel="stylesheet" href="css/leaflet.draw.css" />
    <script src="http://client-solutions.livefyre.com/cid/maps/modernizr-geo.js"></script>
    <script>
    // Polly Fill if browser doesn't support geo
    Modernizr.load({
        test: Modernizr.geolocation,
        yep: '',
        nope: 'http://client-solutions.livefyre.com/cid/maps/geo-polyfill.js'
    });
    </script>
</head>

<body>
    <div id="sidebar" class="sidebar">
        <!-- Nav tabs -->
        <ul class="sidebar-tabs" role="tablist">
            <li class="active"><a href="#home" role="tab" onclick="return false;"><i class="fa fa-bars"></i></a></li>
            <li><a href="#settings" role="tab" onclick="return false;"><i class="fa fa-gear"></i></a></li>
            <li><a href="#profile" role="tab" onclick="return false;"><i class="fa fa-map-marker"></i></a></li>
            <li><a href="#messages" role="tab" onclick="return false;"><i class="fa fa-fast-forward"></i></a></li>
        </ul>

        <!-- Tab panes -->
        <div class="sidebar-content active">
            <div class="sidebar-pane active" id="home">
                <h2>How to Geo Fence Content</h2>
                <p>Use the icons to the left or adjust the Marker <i class="fa fa-map-marker"></i> on the map to get started. If no distance is set in the Settings section <i class="fa fa-gear"></i> a geo fence radial distance of 0.25 </span> will be applied. You can manually move the geo fence by dragging the Marker on the map.</p>
                <p>If you've created a fence and don't see any content below in your App, it's probably because there is no content in your Collection within your fence perimeter. Try moving the Marker or making your fence larger and see what happens (also, check that your Network, longitude and latitude settings are correct ;-)</p>
                <p><a href="http://docs.livefyregeotileapi.apiary.io/#reference">API</a></p>
                <p><a href="https://www.npmjs.com/package/livefyre-geo-collection">NPM</a></p>
            </div>
            <div class="sidebar-pane" id="settings">
                <h2>Collection Settings</h2>
                <form class="form-inline" role="form" id="radius-form">
                    <div class="form-group">
                        <label for="default-values">Default Network: </label>
                        <input  id="default-values" data-network="labs-t402.fyre.co" data-article-id="uat-ben-geo-0" data-site-id="303827" type="checkbox" name="defualts-values" value="true">
                        <div>
                        <label for="network">Network: </label>
                        <input class="" value="" name="network" id="network" placeholder="xxxxxx.fyre.co" />
                        </div>
                        <div>
                        <label for="site-id">SiteId: </label>
                        <input class="" value="" name="site-id" id="site-id" placeholder="xxxxxx" />
                        </div>
                        <div>
                        <label for="article-id">ArticleId: </label>
                        <input class="" value="" name="article-id" id="article-id" placeholder="custom-xxxxxxxxxxxxx" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="perfect-circle">Draw Fence: </label>
                        <input  id="perfect-circle" type="checkbox" name="perfect-circle" value="">
                        <div>
                        <label for="marker-lat">Marker Lat: </label>
                        <input class="" value="" id="marker-lat" placeholder="decimal format" />
                        </div>
                        <div>
                        <label for="marker-lng">Marker Lng: </label>
                        <input class="" value="" id="marker-lng" placeholder="decimal format" />
                        </div>
                        <div>
                            <label for="distance">Fence Radius: </label>
                            <select id="units">
                                <option value="mi">mi</option>
                                <option value="km">km</option>
                                <option value="m">m</option>
                            </select>
                            <input class="" value="" id="distance" placeholder="0.1 â€“ 2000" />
                        </div>
                        <p class="error"></p>
                    </div>
                    <div class="form-group">
                        <button type="submit" class="btn" id="submit-radius">
                            Create Fence
                        </button>
                    </div>
                </form>
            </div>
            <div class="sidebar-pane" id="profile">
                <h2>Marker Coordinates</h2>
                <ul>
                    <li id="js-your-lat">Latitude: <span></span></li>
                    <li id="js-your-lon">Longitude: <span></span></li>
                    <li id="js-your-zoom">Zoom: <span></span></li>
                </ul>
            </div>
            <div class="sidebar-pane" id="messages">
                <h2>Quick Locations</h2>
                <button data-lat="" data-lng="" class="btn quick" id="you">
                    Your Location
                </button>
                <button data-lat="37.7749300" data-lng="-122.4194200" class="btn quick" id="sf">
                    San Francisco
                </button>
                <button class="btn quick" data-lat="38.959902" data-lng="-95.253199" id="kansas">
                    Lawrence, KS
                </button>
                <button class="btn quick" data-lat="40.7142700" data-lng="-74.0059700" id="nyc">
                    New York City
                </button>
            </div>
        </div>
    </div>

    <div id="map" class="sidebar-map"></div>
    <main id="app"></main>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
    <script src="js/leaflet-sidebar.min.js"></script>
    <script src="js/leaflet.draw.js"></script>
    <script src="https://cdn.livefyre.com/Livefyre.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script>

    "use strict";

    var geoCoords = {
        x: null,
        y: null
    };

    var geometry = null;
    var markerMoved = false;
    var marker = null;
    var map = null;
    var drawnItems = null;

    var wall = {
        state: null,
        lf: null
    };

    var collectionDetails = {
        network: null,
        siteId: null,
        articleId: null
    };

    var fence = {
        state: false,
        el: null,
        distance: null,
        unitType: '',
        polyType: ''
    };

    var defaultData = $('#default-values').data();

    // bruces collection http://admin.client-demo-accounts.fyre.co/v3/site/372680/collections/122538518
    var weatherCollection = {
        network: 'client-demo-accounts.fyre.co',
        siteId: 372680,
        articleId: 'custom-1426705037726'
    };

    var cidsWeatherCollection = {
        network: 'sales.fyre.co',
        siteId: 371516,
        articleId: 'custom-1431365679102'
    };

    var bensCollection = {
        network: 'labs-t402.fyre.co',
        siteId: 303827,
        articleId: 'uat-ben-geo-0'
    };

    function geoMarkerCoordsUI(data) {
        $('#js-your-lat > span').text(data.x);
        $('#js-your-lon > span').text(data.y);
        $('#js-your-zoom > span').text(data.z);
    }

    function updateCollectionDeets(data) {
        if (!data) {
            collectionDetails.network = $('#network').val();
            collectionDetails.articleId = $('#article-id').val();
            collectionDetails.siteId = $('#site-id').val();
        } else {
            collectionDetails.network = data.network;
            collectionDetails.articleId = data.articleId;
            collectionDetails.siteId = data.siteId;
            applyInputDeets(data);
        }

        if (local.avaialable) {
            local.setStorage('collectionDetails', collectionDetails);
        }
    }

    var local = {
        avaialable: false,
        getStorage: function (k) {
            var vObj = JSON.parse(window.localStorage.getItem(k));
            return vObj;
        },
        setStorage: function (k, v) {
            var vStr = JSON.stringify(v);
            window.localStorage.setItem(k, vStr);
        },
        checkStorage: function() {
            this.avaialable = (window.localStorage) ?  true : false;
            return this.avaialable;
        }
    };

    function applyInputDeets(collectionDetails) {
        $('#network').val(collectionDetails.network);
        $('#article-id').val(collectionDetails.articleId);
        $('#site-id').val(collectionDetails.siteId);
        (collectionDetails.articleId === 'uat-ben-geo-0') ? $('#default-values').attr('checked', true) : $('#default-values').attr('checked', false);
        updateSettingsGeoInputs(geoCoords);
    }

    function wipeInputDeets(collectionDetails) {
        $('#network').val('');
        $('#article-id').val('');
        $('#site-id').val('');
    }

    function mapSetView(geoCoords) {
        var latlng = L.latLng(geoCoords.x, geoCoords.y);
        map.setView(latlng);
        marker.setLatLng(latlng);
        marker.setPopupContent('Latitude: ' + geoCoords.x + ' <br /> Longitude: ' + geoCoords.y);
        markerMoved = true;
        geoMarkerCoordsUI(geoCoords);
        updateSettingsGeoInputs(geoCoords);
        createPoly(geoCoords);
    }

    function drawClear(drawnItems) {
        try {
            drawnItems.clearLayers();
        } catch (e) {}
    }

    function drawInit(cb) {
        // Initialise the FeatureGroup to store editable layers
        drawnItems = new L.FeatureGroup();
        map.addLayer(drawnItems);

        // Initialise the draw control and pass it the FeatureGroup of editable layers
        var options = {
            position: 'topleft',
            draw: {
                polyline: {
                    allowIntersection: false,
                    shapeOptions: {
                        color: 'red',
                        weight: 2
                    }
                },
                polygon: false,
                circle: {
                    shapeOptions: {
                        clickable: true
                    }
                },
                rectangle: false,
                marker: false
            },
            edit: {
                featureGroup: drawnItems, //REQUIRED!!
                remove: false
            }
        };

        var drawControl = new L.Control.Draw(options);
        map.addControl(drawControl);
        // Event Handlers
        // Most have draw:event<start|stop>

        map.on('draw:drawstart', function (e) {
            console.log('start');
            // only allow one layer at a time
            drawClear(drawnItems);
        });

        map.on('draw:editstart', function (e) {
            console.log(e)
        });

        map.on('draw:edited', function (e) {
            var layersGeoJSON = drawnItems.toGeoJSON();
            var layer = e.layers._layers;
            var id = Object.keys(layer);

            geometry = layersGeoJSON.features[0].geometry;
            checkFenceState(fence);

            if (fence.polyType === 'circle') {

                // Explicitly use Meters
                unitType.set('m');
                fence.distance = layer[id]._mRadius;

                // update view
                updateGeoCoords(layer[id]._latlng.lat, layer[id]._latlng.lng);
                createPoly(geoCoords, fence.distance);

            } else if (fence.polyType === 'polyline') {
                line_points = layer.getLatLngs();
                var polyline = L.polygon(line_points).addTo(drawnItems);

                // Get middle latLng on polyline
                var center = layer.getBounds().getCenter();

                updateGeoCoords(center.lat, center.lng);
                createPoly(geoCoords);
            }

            moveMarker(geoCoords);
            markerUpdate(geoCoords);

            // TODO redefine gemometry after successful edit. rendermedialwall
            // drawClear(drawnItems);
            console.log(layer)
        });


        map.on('draw:created', function (e) {
            console.log('draw:created');
            // TODO - Refactor and get shit out of here.
            var type = e.layerType,
                layersGeoJSON = null,
                layer = e.layer,
                feature = null,
                line_points = [];

            // add Layer to Control Group
            drawnItems.addLayer(layer);
            layersGeoJSON = drawnItems.toGeoJSON();
            geometry = layersGeoJSON.features[0].geometry

            fence.polyType = type;

            if (type === 'circle') {

                // Explicitly use Meters
                unitType.set('m');
                fence.distance = layer._mRadius;

                // update view
                updateGeoCoords(layer._latlng.lat, layer._latlng.lng);
                createPoly(geoCoords, fence.distance);

            } else if (type === 'polyline') {
                line_points = layer.getLatLngs();
                var polyline = L.polygon(line_points).addTo(drawnItems);

                // Get middle latLng on polyline
                var center = layer.getBounds().getCenter();

                updateGeoCoords(center.lat, center.lng);
                createPoly(geoCoords);
            }

            moveMarker(geoCoords);
            markerUpdate(geoCoords);

        });

    }

    function mapInit(geoCoords) {

        var map = window.map = L.map('map', {
            zoomControl: false
        });

        var zoomControl = L.control.zoom({
            position: 'topright'
        });

        map.locate({
            setView: true,
            maxZoom: 15,
            enableHighAccuracy: true,
            maximumAge: 59999.9
        });

        L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: 'Livefyre Geo Maps',
            reuseTiles: true,
            detectRetina: true
        }).addTo(map);

        map.addControl(zoomControl);
        drawInit();

        map.on('load', function(e) {

            var center = map.getCenter();
            updateGeoCoords(center.lat, center.lng, map.getZoom());
            $('#you').data({
                'lat': geoCoords.x,
                'lng': geoCoords.y
            });

            markerAdd(center);
            updateSidebarMarkerView(geoCoords);
            updateSettingsGeoInputs(geoCoords);

            var sidebar = L.control.sidebar('sidebar').addTo(map);

        });

        map.on('zoomend', function(e) {
            var z = map.getZoom();
            updateGeoCoords(geoCoords.x, geoCoords.x, z);
            $('#js-your-zoom > span').text(z);
        });

    }

    var unitType = {
        set: function (val) {
            fence.unitType = val;
            return fence.unitType;
        },
        get: function () {
            fence.unitType = fence.unitType || $('#units').val();
            return fence.unitType;
        }
    };

    function checkFenceState (fence) {
        if (fence.state) {
            removeFence(fence);
        }
    }

    function addFence(geometry) {
      fence.state = true;
      fence.el = L.geoJson(geometry, {
          style: function(feature) {
              return {
                  color: 'red'
              };
          },
          onEachFeature: function(feature, layer) {
              layer.bindPopup('The diameter of your fence is <br /> ' + (fence.distance * 2) +' ' + unitType.get() + '.');
          }
      });
      map.addLayer(fence.el);
      map.fitBounds(fence.el.getBounds());

    }

    function removeFence(fence) {
      try {
          map.removeLayer(fence.el);
      } catch (e) {}
    }

    function updateSidebarMarkerView(geoCoords) {
        $('#js-your-lat > span').text(geoCoords.x);
        $('#js-your-lon > span').text(geoCoords.y);
        $('#js-your-zoom > span').text(geoCoords.z);
    }

    function updateSettingsGeoInputs(geoCoords) {
        $('#marker-lng').val(geoCoords.y);
        $('#marker-lat').val(geoCoords.x);
    }

    function moveMarker(geoCoords) {
        var latlng = L.latLng(geoCoords.x, geoCoords.y);
        marker.setLatLng(latlng);
    }

    function markerUpdate(geoCoords) {
        marker.setPopupContent('Latitude: ' + geoCoords.x + ' <br /> Longitude: ' + geoCoords.y);
        geoMarkerCoordsUI(geoCoords);
        updateSettingsGeoInputs(geoCoords);
    }

    function markerAdd(o) {
        marker = L.marker([o.lat, o.lng], {
            draggable: true
        });

        marker.addTo(map);
        marker.bindPopup('Found you!');
        marker.openPopup();

        marker.on('dragend', function (e) {
            drawClear(drawnItems);
            fence.unitType = unitType.get();
            fence.polyType = 'circle';
            updateGeoCoords(e.target._latlng.lat, e.target._latlng.lng);
            markerUpdate(geoCoords);
            createPoly(geoCoords);
            markerMoved = true;
        });
    }

    function updateGeoCoords(lat, lng, z) {
        geoCoords.x = lat;
        geoCoords.y = lng;
        geoCoords.z = z || map.getZoom();
    }

    function renderMediawall(geometry) {
        var geomArr = [];
      if (wall.state) {
        try {
            wall.destroy();
            $('#map').after('<main id="app"></main>');
        } catch (e) { }
      }

      if (!collectionDetails.network || !collectionDetails.articleId || !collectionDetails.siteId) {
        updateCollectionDeets(defaultData);
      }

      if (fence.polyType === 'polyline') {
        geomArr = [geometry.coordinates];
      } else {
        geomArr = geometry.coordinates;
      }

      console.log(fence.polyType, geometry);

      Livefyre.require([
              'streamhub-wall#3',
              'streamhub-sdk#2',
              'livefyre-geo-collection#0'

          ],
          function(Wall, SDK, GeoCollection) {

              var appEl = document.getElementById('app');
              var geoCollection = new(GeoCollection.GeoCollection)({
                  collection: collectionDetails,
                  geometry: {
                    type: "Polygon",
                    coordinates: geomArr
                  },
                  transformState: function stateToContent(state) {
                      var contents = SDK.StateToContent.transform(state);
                      if (!(contents && contents.length)) {
                          return;
                      }
                      var content = contents[0];
                      return content;
                  }
              });

              wall.lf = window.wall = new Wall({
                  el: appEl,
                  collection: geoCollection
              });

            if (local.avaialable) {
                local.setStorage('collectionDetails', collectionDetails);
            }

          });
      wall.state = true;
    }

    function createPoly(geoCoords, distance) {
        console.log('create called');
        checkFenceState(fence);
        console.log(fence.polyType);

        if (!fence.polyType) {
            fence.polyType = 'circle';
        }

        console.log(fence.polyType);
        if (fence.polyType === 'circle') {

            var radiusInMeters, validInput, angleDegrees;

            fence.distance = distance || parseFloat($('#distance').val(), 10);
            fence.distance = (fence.distance > 0) ? fence.distance : parseFloat('.125', 10);

            radiusInMeters = _convertDistanceToMeters(fence);
            validInput = _validateDistance(radiusInMeters);
            console.log(fence.distance, fence.unitType, radiusInMeters, validInput);

            if (!validInput) {
                $('.error').text('Those numbers are out of range. Try again.');
            } else {
                angleDegrees = _angularRadiusFromSurfaceRadius(radiusInMeters);
                geometry = _createPolyCircle(angleDegrees, geoCoords);
                $('#distance').val(fence.distance);
//                $('#perfect-circle').attr('checked', true);
                $('#submit-radius').text('Update Fence');
            }
        } else if  (fence.polyType === 'polyline') {
            //console.dir('polyline', geometry);
        }

        console.dir(geometry);

        addFence(geometry);
        renderMediawall(geometry);
        _validateGeoJSON(geometry);

        function _validateDistance(r) {
            var MAX = 3220290; // ~2000 miles
            var MIN = parseFloat('.1', 10);
            return (r < MAX && r > MIN) ? true : false;
        }


        function _convertDistanceToMeters(fence) {
            // TODO turn this into a utility function that can turn m<=>km, m<=>mi, mi<=>km
            var distMeters;
            if (fence.unitType === 'm') {
                distMeters = fence.distance;
            } else if (fence.unitType === 'km') {
                distMeters = fence.distance * 1000;
            } else if (fence.unitType === 'mi') {
                distMeters = fence.distance * 1609.34;
            }
            return distMeters;
        }

        function _angularRadiusFromSurfaceRadius(surfaceRadius) {
            var DISTANCE_TO_CENTER_OF_EARTH_METERS = 6371000;
            var angle = ((surfaceRadius / DISTANCE_TO_CENTER_OF_EARTH_METERS * 180)) / Math.PI;
            return angle;
        }

        function _createPolyCircle(angle, geoCoords) {
            return d3.geo.circle()
              .origin([geoCoords.y, geoCoords.x])
              .angle(angle).precision(1)();
        }

        function _validateGeoJSON(geometry) {
            var processSuccess, processError, geoJSON;
            geoJSON = {
                type: "FeatureCollection",
                features: [{
                    type: "Feature",
                    properties: {
                        description: 'Your App will only see content from this shape',
                        color: '#dddddd'
                    },
                    geometry: geometry
                }]
            };

            geoJSON = JSON.stringify(geoJSON);

            processSuccess = function(data) {
                if (data.status === 'ok') {} else if (data.status === 'error') {
                    console.log('There was a problem with your GeoJSON: ' + data.message);
                }
            };

            processError = function() {
                console.log('There was a problem with your ajax.');
            };

            $.ajax({
                url: 'http://geojsonlint.com/validate',
                type: 'POST',
                data: geoJSON,
                dataType: 'json',
                success: processSuccess,
                error: processError
            });
        }
    }

    // Click Handlers
    $('body').on('change', '#default-values', function (e) {
        e.preventDefault();
        var $el = $(e.target);
        if ($el.is(":checked")) {
            updateCollectionDeets(defaultData);
            createPoly(geoCoords);
            $el.attr('checked', true);
        } else {
            wipeInputDeets();
            updateCollectionDeets();
        }
    });


    $('body').on('change', '#perfect-circle', function (e) {
        e.preventDefault();
        var $el = $(e.target);
        var $drawEl = $('.leaflet-draw');
        ($el.is(":checked")) ?  $drawEl.fadeIn() : $drawEl.fadeOut();
    });

    $('body').on('click', '.quick', function(e) {
        var $el = $(e.target);
        if ($el.hasClass('active')) {
            return;
        }
        $el.addClass('active');
        $el.siblings('button').removeClass('active');
        $('#distance').val(10);
        updateGeoCoords(parseFloat($el.data('lat')), parseFloat($el.data('lng')));
        mapSetView(geoCoords);
    });

    $('#radius-form').submit(function(e) {
        e.preventDefault();
        var lng = parseFloat($('#marker-lng').val());
        var lat = parseFloat($('#marker-lat').val());

        $('.error').text('');
        $('.quick').removeClass('active');
        updateCollectionDeets();

        if (!isNaN(lng) && !isNaN(lat)) {
            updateGeoCoords(lat, lng);
        }
        createPoly(geoCoords);
    });

    $(document).ready(function () {
        if (local.checkStorage()) {
            if (local.getStorage('collectionDetails') && local.getStorage('collectionDetails') !== '') {
                applyInputDeets(local.getStorage('collectionDetails'));
            }
        }
        mapInit(geoCoords);
    });

    </script>
</body>

</html>